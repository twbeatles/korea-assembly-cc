# 🏛️ 국회 의사중계 자막 추출기 v16.12

국회 의사중계 웹사이트에서 **실시간 AI 자막**을 자동으로 추출하고 저장하는 PyQt6 기반 데스크톱 프로그램입니다.

![Python](https://img.shields.io/badge/Python-3.9+-blue)
![PyQt6](https://img.shields.io/badge/GUI-PyQt6-green)
![Selenium](https://img.shields.io/badge/Automation-Selenium-orange)
![Platform](https://img.shields.io/badge/Platform-Windows-lightgrey)

---

## 📋 목차
- [새 기능 (v16.12)](#-v1612-새-기능)
- [주요 기능](#-주요-기능)
- [설치 방법](#-설치-방법)
- [사용 방법](#-사용-방법)
- [단축키](#️-단축키)
- [저장 형식](#-저장-형식)
- [상세 기능 설명](#-상세-기능-설명)
- [문제 해결](#-문제-해결)
- [빌드 방법](#️-빌드-방법)
- [변경 이력](#-변경-이력)
- [파이프라인 고정 문서](#-파이프라인-고정-문서)

---

## ✨ v16.12 새 기능 (Hot!)

### 🎤 발언자 전환 즉시 감지 (Zero-Delay)
- **자막 영역 클리어 감지** - 발언자가 바뀔 때 자막 영역이 비워지는 순간을 **실시간으로 감지**합니다.
- **즉시 완전 리셋** - 기존에는 2초간 자막이 멈추던 현상을 해결하여, 새 발언자의 첫 마디를 놓치지 않고 **즉시 수집**합니다.
- **버퍼 확정** - 전환 직전의 마지막 텍스트가 유실되지 않도록 강제로 저장합니다.

### 🧬 MutationObserver 하이브리드 엔진
- **이벤트 기반 캡처** - JavaScript `MutationObserver`를 사용하여 자막 변경을 실시간 이벤트로 감지합니다.
- **폴링 Fallback** - 기존의 0.2초 폴링 방식도 함께 작동하여 어떤 상황에서도 자막을 놓치지 않는 **이중 안전장치**를 구축했습니다.
- **자동 재주입** - 페이지 새로고침이나 네트워크 재연결 시에도 Observer가 자동으로 재설치됩니다.

### 🎯 코어 정확성 및 안정성 강화
- **스마트 Suffix 매칭 (`rfind`)** - "위원장... 위원장..." 처럼 반복되는 문구 처리 시 과잉 추출 문제를 원천 차단했습니다.
- **소프트 리셋 (Soft Resync)** - 네트워크 지연 등으로 동기화가 깨졌을 때, 전체 데이터를 날리지 않고 최근 10초간의 자막 맥락만 유지하며 **자연스럽게 복구**합니다.
- **대량 중복 방지** - 리셋 직후 발생할 수 있는 대량 중복 텍스트 유입을 알고리즘 레벨에서 차단했습니다.

---

## ✨ v16.11 주요 개선 사항

### 🧠 자막 수집 알고리즘 완벽 재설계
- **글로벌 히스토리 Suffix 매칭** - 확정된 모든 텍스트를 누적하고, 새 raw에서 히스토리의 마지막 부분(suffix) 이후만 추출
- **DOM 루핑 면역** - 웹사이트 특유의 텍스트 반복/루핑 현상 완벽 대응
- **자막 반복 완전 해결** - 기존 앵커 기반, 버퍼 비교, 문장 해시 방식 모두 실패 → 새 알고리즘으로 해결

### 🛡️ 파이프라인 안정화 고정
- **입력 게이트 레이어** - `preview`는 `_prepare_preview_raw`를 통과한 뒤 코어 알고리즘으로 전달
- **다단계 fallback** - suffix desync/ambiguous 상황에서 증분 우선 추출
- **안전한 재동기화** - 반복 실패 시에만 제한적으로 리셋 수행

---

## 📌 파이프라인 고정 문서

자막 수집 구조 고정 기준은 아래 문서를 참고하세요.

- `PIPELINE_LOCK.md`

---

## ✨ 주요 기능

### 🎯 실시간 자막 추출
- 국회 의사중계 웹사이트의 AI 자막을 실시간으로 캡처
- **스트리밍 엔진**: 딜레이 없이 즉시 자막 표시 및 저장
- 중복 자막 자동 제거 및 스마트 이어붙이기

### 💾 다양한 저장 형식
TXT, SRT, VTT, DOCX, HWP, RTF, JSON 세션 저장

### 🔍 검색 및 하이라이트
- **실시간 검색** (Ctrl+F)
- **키워드 하이라이트** - 특정 단어 강조
- **알림 키워드** - 감지 시 토스트 알림

### 🏛️ 상임위원회 프리셋
- 상임위원회/특별위원회 URL 빠른 선택
- 사용자 정의 프리셋 추가/관리
- **생중계 목록 선택** - 현재 방송을 목록에서 직접 선택 (📡 생중계 목록)

### ⚙️ 편의 기능
- 헤드리스 모드 (브라우저 창 숨김)
- 실시간 저장, 세션 저장/불러오기
- 자동 백업 (5분마다)
- 다크/라이트 테마

---

## 📦 설치 방법

### 1. Python 설치
Python 3.9 이상이 필요합니다.
- [Python 공식 사이트](https://www.python.org/downloads/)에서 다운로드

### 2. 필수 라이브러리 설치
```bash
pip install PyQt6 selenium
```

### 3. 선택 라이브러리 (추가 기능)
```bash
pip install python-docx  # DOCX (Word) 저장용
pip install pywin32      # HWP (한글) 저장용
```

### 4. Chrome 브라우저
- Chrome 브라우저가 설치되어 있어야 합니다
- Selenium 4.x가 자동으로 WebDriver를 관리합니다

---

## 🚀 사용 방법

### 기본 사용법

#### 1단계: 프로그램 실행
```bash
python "국회의사중계 자막.py"
```

#### 2단계: 위원회 선택
세 가지 방법 중 선택:

**방법 A: 프리셋 사용 (권장)**
1. `📋 상임위` 버튼 클릭
2. 원하는 위원회 선택 (예: 본회의, 법제사법위원회)
3. URL이 자동으로 입력됨

**방법 B: 직접 URL 입력**
1. URL 입력창에 국회 의사중계 URL 입력
2. 예: `https://assembly.webcast.go.kr/main/player.asp?xcode=10`

**방법 C: 생중계 목록 선택**
1. `📡 생중계 목록` 버튼 클릭
2. 목록에서 현재 방송 선택
3. URL이 자동으로 입력됨

#### 3단계: 옵션 설정
- ✅ **자동 스크롤**: 새 자막이 추가될 때 자동으로 아래로 스크롤 (사용자 스크롤 시 일시 중지)
- ✅ **실시간 저장**: 자막을 파일에 실시간으로 저장 (realtime_output 폴더)
- ✅ **헤드리스 모드**: 브라우저 창을 숨기고 백그라운드에서 실행

#### 4단계: 추출 시작
- `▶ 시작` 버튼 클릭 또는 **F5** 키
- 상태바에서 진행 상황 확인:
  - `🔍 현재 생중계 감지 중...` - xcgcd 자동 탐지 진행
  - `✅ 생중계 감지 성공!` - 오늘 생중계 발견
  - `자막 모니터링 중` - 정상 동작 중
- 연결 상태 표시: 🟢 연결됨, 🔴 끊김, 🟡 재연결 중

#### 5단계: 자막 확인
- 왼쪽 패널에 자막이 실시간으로 표시됨
- 오른쪽 통계 패널에서 글자수, 단어수, 실행 시간 확인
- `⏳` 표시는 아직 확정되지 않은 진행 중 자막

#### 6단계: 저장
추출 완료 후 다양한 형식으로 저장 (자동 파일명 제안됨):
- **파일 → TXT 저장** (Ctrl+S) - 일반 텍스트
- **파일 → SRT 저장** - 자막 파일 형식
- **파일 → DOCX 저장** - Word 문서
- **파일 → 세션 저장** (Ctrl+Shift+S) - 나중에 다시 불러오기 가능 + DB 저장

---

## ⌨️ 단축키

### 기본 조작
| 단축키 | 기능 |
|--------|------|
| **F5** | 추출 시작 |
| **Escape** | 추출 중지 |
| **Ctrl+Q** | 프로그램 종료 |

### 검색 및 편집
| 단축키 | 기능 |
|--------|------|
| **Ctrl+F** | 검색창 열기 |
| **F3** | 다음 검색 결과 |
| **Shift+F3** | 이전 검색 결과 |
| **Ctrl+E** | 자막 편집 |
| **Delete** | 자막 삭제 |
| **Ctrl+C** | 전체 자막 복사 |

### 저장
| 단축키 | 기능 |
|--------|------|
| **Ctrl+S** | TXT 저장 |
| **Ctrl+Shift+S** | 세션 저장 |
| **Ctrl+O** | 세션 불러오기 |
| **Ctrl+Shift+M** | 자막 병합 |

### 보기
| 단축키 | 기능 |
|--------|------|
| **Ctrl+T** | 테마 전환 (다크/라이트) |
| **Ctrl++** | 글자 크기 키우기 |
| **Ctrl+-** | 글자 크기 줄이기 |
| **F1** | 사용법 가이드 |

---

## 📄 저장 형식

| 형식 | 확장자 | 설명 | 필요 라이브러리 |
|------|--------|------|-----------------| 
| **TXT** | .txt | 타임스탬프 포함 텍스트 | 없음 |
| **SRT** | .srt | SubRip 자막 파일 | 없음 |
| **VTT** | .vtt | WebVTT 자막 파일 | 없음 |
| **DOCX** | .docx | Word 문서 | python-docx |
| **HWP** | .hwp | 한글 문서 | pywin32 + 한컴오피스 |
| **RTF** | .rtf | 서식 있는 텍스트 (HWP 호환) | 없음 |
| **JSON** | .json | 세션 저장 (복원 가능) | 없음 |
| **SQLite** | .db | 데이터베이스 히스토리 | 없음 (내장) |

---

## 📚 상세 기능 설명

### 자막 파이프라인 고정 구조 (중요)
현재 자막 수집 파이프라인은 아래 구조로 **고정**되어 있습니다.

1. **Worker (하이브리드)**:
   - 선택자 후보를 우선순위로 구성: `#viewSubtit .smi_word:last-child` → `#viewSubtit .smi_word` → 컨테이너 계열
   - 기본 문서 + 중첩 iframe/frame 경로를 순회해 자막 요소 탐색
   - `MutationObserver` 주입 우선, 실패 시 JS 폴링 브리지(약 180ms) 활성화
   - 메인 루프(0.2초)에서 Observer 버퍼 우선 수집, 없으면 폴링 fallback
   - **자막 영역 클리어 감지** 시 `subtitle_reset` 신호 전송
2. **UI Queue**:
   - `subtitle_reset` 수신 시 **즉시 완전 리셋** 및 이전 버퍼 확정
   - `preview` 메시지를 `_prepare_preview_raw`로 정규화/게이팅
3. **Core Algorithm**:
   - 통과된 입력만 `_process_raw_text`(글로벌 히스토리 + Suffix)로 전달
   - `rfind`를 사용하여 반복 문구 과잉 추출 방지
4. **후단 정제**:
   - `get_word_diff`로 미세 중복 제거
   - recent compact tail 체크로 대량 반복 블록 재누적 차단
   - `_join_stream_text`로 문장부호 기준 공백 결합(웹 표시 형태 최대 보존)
5. **종료 처리**:
   - `_drain_pending_previews`에서 남은 큐 소진
   - 마지막 항목 보정 및 저장

운영 원칙:
- 코어 알고리즘(`_process_raw_text`, `_extract_new_part`)은 직접 수정하지 않음
- 반복/누락 이슈는 우선 게이트 임계값과 fallback 경로에서 조정
- 로그 키워드: `subtitle_reset 감지`, `preview suffix desync reset`, `MutationObserver 주입 성공`, `MutationObserver 폴링 브리지 활성화`

---

## 🔧 문제 해결

### Chrome 시작 오류
- Chrome 브라우저가 최신 버전인지 확인
- 프로그램이 자동으로 최대 3회 재시도합니다
- Selenium 4.x가 WebDriver를 자동 관리합니다

### 자막이 표시되지 않음
1. 국회 의사중계 페이지에서 자막이 활성화되어 있는지 확인
2. 다른 CSS 선택자 시도: `#viewSubtit .smi_word:last-child`, `#viewSubtit .smi_word`, `#viewSubtit .incont`
3. 생중계가 진행 중인지 확인
4. URL에 `xcgcd`가 포함되어 있는지 확인 (또는 `📡 생중계 목록`에서 선택)

### 연결이 자주 끊김
- v16.6부터 자동 재연결이 지원됩니다
- 상태바에서 연결 상태(🟢/🔴/🟡) 확인
- 네트워크 환경 점검 필요

### HWP 저장 오류
- **한글 오피스**가 설치되어 있어야 합니다
- 저장 실패 시 RTF/DOCX/TXT 대체 형식을 선택할 수 있습니다
- RTF 파일은 한글에서 열 수 있습니다

---

## 🛠️ 빌드 방법

### PyInstaller로 EXE 빌드
```bash
# PyInstaller 설치
pip install pyinstaller

# 빌드 실행
pyinstaller subtitle_extractor.spec

# 결과물
dist/subtitle_extractor.exe  # 단일 실행 파일 (~80MB)
```

---

## 📝 변경 이력

### v16.12 (2026-02-12)
- 🎤 **발언자 전환 즉시 감지**: 자막 영역 클리어 시 즉시 리셋으로 2초 딜레이 제거
- 🧬 **하이브리드 엔진**: MutationObserver + 폴링 구조로 수집 신뢰성 극대화
- 🎯 **정확성 향상**: `rfind` 도입으로 Suffix 충돌 방지, `소프트 리셋`으로 복구 안정성 강화
- 📝 **문서 업데이트**: PIPELINE_LOCK.md 및 알고리즘 분석 문서 최신화

### v16.11 (2026-01-29)
- 🧠 **자막 알고리즘 완벽 재설계**: 글로벌 히스토리 Suffix 매칭 알고리즘 도입
- 📝 **타임스탬프 저장 개선**: TXT/DOCX/HWP 저장 시 1분 간격으로 타임스탬프 표시
- 🐛 **버그 수정**: 줄넘김 정리 후 자막 수집 중단 오류 해결, end_time null 오류 수정

### v16.10 (2026-01-27)
- ⚡ **스트리밍 아키텍처**: 자막 수집 로직 전면 재설계 (Diff & Append 방식)
- 🐛 **버그 수정**: 1분 이상 자막 수집 시 사라지는 문제 해결
- 🛡️ **안정성**: 중지 버튼 클릭 시 크래시 해결
- 🎨 **UI**: 버튼 레이아웃 개선 및 키워드 입력창 복구

### v16.9 (2026-01-23)
- 🛡️ **데이터 안정성 강화**: 자동 백업 백그라운드 처리 + 중복 실행 방지
- 🔒 **스레드 안전성**: 자막 데이터 접근 락(Lock) 전면 적용
- ⚡ **DB 성능 개선**: 연결 캐싱, FTS5 검색 적용, 대량 삽입 최적화

### v16.8 (2026-01-23)
- 🧾 **상임위원회 xcode 최신화** (기재위, 여가위, 정무위 등 반영)
- ⚡ **성능 최적화**: 정규식/포맷 캐싱, 통계 캐시

### v16.7 (2026-01-23)
- 🧭 **URL 감지 강화**: API 기반 xcgcd 자동 보완
- 📡 **생중계 목록 선택 UI**: 현재 방송 직접 선택 버튼
- 🧩 **특별위원회 지원**: 국정감사 등 특위 코드 대응

### v16.6 (2026-01-22)
- 🔌 **연결 상태 모니터링**: 상태바 아이콘 표시
- 🔄 **자동 재연결**: 지수 백오프 재시도
- 📝 **자동 파일명 생성**: 위원회명 자동 추출
- 🗄️ **SQLite 데이터베이스**: 세션 히스토리 및 검색
- 📎 **자막 병합**: 다중 세션 병합 도구

---

## 📄 라이선스

MIT License

© 2024-2026
